FROM ubuntu:24.04

# Install system packages
RUN apt-get update && \
    apt-get install -y \
    sudo git curl \
    build-essential pkg-config libssl-dev \
    ca-certificates \
    default-mysql-client \
    python3 python3-dev python3-venv python3-pip && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Create Python symlink
RUN ln -sf /usr/bin/python3 /usr/local/bin/python

# Create host user
RUN useradd -m -s /bin/bash host && \
    echo 'host ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

USER host
WORKDIR /home/host
ENV HOME=/home/host

# Install Node.js via NVM
RUN curl -o- https://raw.githubusercontent.com/creationix/nvm/master/install.sh | bash && \
    export NVM_DIR="$HOME/.nvm" && \
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" && \
    nvm install --lts && \
    nvm use --lts && \
    nvm alias default lts/*

# Install Rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | bash -s -- -y

# Create global symlinks as root
USER root
RUN export NVM_DIR="/home/host/.nvm" && \
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" && \
    NODE_VERSION=$(nvm version default) && \
    ln -sf $NVM_DIR/versions/node/$NODE_VERSION/bin/node /usr/local/bin/node && \
    ln -sf $NVM_DIR/versions/node/$NODE_VERSION/bin/npm /usr/local/bin/npm && \
    ln -sf /home/host/.cargo/bin/cargo /usr/local/bin/cargo && \
    ln -sf /home/host/.cargo/bin/rustc /usr/local/bin/rustc

# Setup environment for runtime builds
ENV NVM_DIR=/home/host/.nvm
ENV CARGO_HOME=/home/host/.cargo

# Copy the pre-built binary from local build
COPY target/release/raworc-operator /usr/local/bin/raworc-operator

CMD ["raworc-operator"]